-- GUIAS PARA CRUZARLAS CON EL ITINERARIO PARA QUE APAREZCAN EN EL TABLERO DE EXPO
-- GUIAS PARA CRUZARLAS CON EL ITINERARIO PARA QUE APAREZCAN EN EL TABLERO DE EXPO
SELECT DISTINCT 
    F.FLUP_FLIGHT_NO_LVG, 
    F.FLUP_FLIGHT_NO NU_VUEL,
    LPAD ( LPAD (LABS_MAWB_PREFIX, 4, 0) || '' || LPAD (LABS_MAWB_SERIAL_NO, 8, 0), 12, 0) AS Guia,
    F.FLUP_SCHEDULED_DATE,
    F.FLUP_INT_NUMBER AS MANIFEST_NUMBER,
    TO_CHAR (F.FLUP_SCHEDULED_DATE + TO_DATE ('02/01/0001', 'DD/MM/YYYY'),'DD/MM/YYYY')AS FE_VUEL,
    --COUNT (DISTINCT LABS.LABS_IDENT_NO) OVER (PARTITION BY F.FLUP_INT_NUMBER,LABS.LABS_IDENT_NO) AS NROGUIAS,
    --AWBU.AWBU_PIECES as NROBULTOS,
    --AWBU.AWBU_WEIGHT AS NROKILOS,                       
    'LIM' AS CO_PUER_ORIG,
    F.FLUP_AIRPORT_CODE_1 AS CO_PUER_DEST

FROM  LIM_W1_HL.FLUP@TLMHERMES F
INNER JOIN LIM_W1_HL.BOOK_BOOKINGS@TLMHERMES BOOK  ON F.FLUP_INT_NUMBER = BOOK.BOOK_FLIGHT_ISN 
INNER JOIN LIM_W1_HL.LABS@TLMHERMES LABS           ON LABS.LABS_IDENT_NO = BOOK.BOOK_LABS_IDENT AND LABS.LABS_RECORD_TYPE <> 'MASTER'
INNER JOIN LIM_W1_HL.AWBU_AWBPERULD_LIST@TLMHERMES AWBU ON BOOK.BOOK_LABS_IDENT = AWBU.AWBU_MAWB_IDENT_NO 
--INNER JOIN LIM_W1_HL.PALO@TLMHERMES PALO ON PALO.PALO_ULD_ISN = AWBU.AWBU_ULD_ISN AND F.FLUP_SCHEDULED_DATE = PALO.PALO_DEPARTURE_DATE_OUT
--INNER JOIN LIM_W1_HL.CONT@TLMHERMES ON CONT.CONT_ULD_ISN = PALO.PALO_ULD_ISN AND CONT.CONT_COMPLETE_CALCULATED_ULD = 1
--                                      AND cont.CONT_FLIGHT_NO_ = F.FLUP_FLIGHT_NO
--                                      AND cont.CONT_DATE = F.FLUP_SCHEDULED_DATE
--                                      AND cont.CONT_ULD_ISN = PALO.PALO_ULD_ISN
WHERE F.FLUP_SCHEDULED_DATE + TO_DATE ('02/01/0001', 'DD/MM/YYYY') BETWEEN  to_date('27/04/2018','DD/MM/YYYY') and  to_date('28/04/2018','DD/MM/YYYY')
AND F.FLUP_FLIGHT_NO_LVG = 'UA'
AND F.FLUP_FLIGHT_NO = '855'

UNION ALL

SELECT DISTINCT 
F.FLUP_FLIGHT_NO_LVG, 
F.FLUP_FLIGHT_NO NU_VUEL,
LPAD ( LPAD (LABS_MAWB_PREFIX, 4, 0) || '' || LPAD (LABS_MAWB_SERIAL_NO, 8, 0), 12,0) AS Guia,
F.FLUP_SCHEDULED_DATE,
F.FLUP_INT_NUMBER AS MANIFEST_NUMBER,
TO_CHAR ( F.FLUP_SCHEDULED_DATE + TO_DATE ('02/01/0001', 'DD/MM/YYYY'), 'DD/MM/YYYY') AS FE_VUEL,
--SUM (GRDI.GRDI_DELIVERY_PIECES) OVER ( PARTITION BY F.FLUP_INT_NUMBER,PALO.PALO_ULD_ISN,LABS.LABS_MAWB_SERIAL_NO,HAWB.HAWB_HOUSE_NUMBER) AS NROBULTOS,
--SUM (GRDI.GRDI_DELIVERY_WEIGHT) OVER ( PARTITION BY F.FLUP_INT_NUMBER,PALO.PALO_ULD_ISN,LABS.LABS_MAWB_SERIAL_NO,HAWB.HAWB_HOUSE_NUMBER) AS NROKILOS,
'LIM' AS CO_PUER_ORIG,
F.FLUP_AIRPORT_CODE_1 AS CO_PUER_DEST

FROM LIM_W1_HL.LABS@TLMHERMES LABS
    INNER JOIN LIM_W1_HL.GRPHR_GROUP_HOUSE_RELATION@TLMHERMES GRPHR ON  LABS.LABS_IDENT_NO = GRPHR.GRPHR_AWB_IDENT AND LABS.LABS_RECORD_TYPE = 'MASTER'
    INNER JOIN LIM_W1_HL.HAWL_HOUSE_WAYBILL_LOADED@TLMHERMES HAWB_LOAD ON HAWB_LOAD.HAWL_HOUSE_ISN = GRPHR.GRPHR_HOUSE_ISN
    INNER JOIN LIM_W1_HL.HAWB_HOUSE_WAYBILL_DETAILS@TLMHERMES HAWB ON  HAWB.HAWB_HOUSE_ISN = HAWB_LOAD.HAWL_HOUSE_ISN
    INNER JOIN LIM_W1_HL.BOOK_BOOKINGS@TLMHERMES BOOK  ON            LABS.LABS_IDENT_NO = BOOK.BOOK_LABS_IDENT  -- AND BOOK_DELETED=0 /*SE AGREG0*/
    INNER JOIN LIM_W1_HL.FLUP@TLMHERMES F ON
                                                                    F.FLUP_FLIGHT_NO_LVG = BOOK.BOOK_FLIGHT_AIRLINE
                                                                    AND F.FLUP_FLIGHT_NO = BOOK.BOOK_FLIGHT_NUMBER
                                                                    AND F.FLUP_INT_NUMBER = BOOK.BOOK_FLIGHT_ISN 
    INNER JOIN LIM_W1_HL.PALO@TLMHERMES PALO   ON PALO.PALO_ULD_ISN = HAWB_LOAD.HAWL_ULD_ISN                                  
    --INNER JOIN LIM_W1_HL.CONT@TLMHERMES CONT   ON PALO.PALO_ULD_ISN = CONT.CONT_ULD_ISN AND CONT.CONT_COMPLETE_CALCULATED_ULD = 1
    --                                                                                      AND cont.CONT_FLIGHT_NO_ = F.FLUP_FLIGHT_NO
    --                                                                                      AND cont.CONT_DATE = F.FLUP_SCHEDULED_DATE
    --                                                                                      AND cont.CONT_ULD_ISN = PALO.PALO_ULD_ISN 
    --INNER JOIN LIM_W1_HL.GRDI_GROUP_DELIVERY_INFO@TLMHERMES GRDI ON  GRDI.GRDI_OBJECT_ISN = LABS.LABS_IDENT_NO
    --                                                                 AND GRDI.GRDI_ULD_ISN = HAWB_LOAD.HAWL_ULD_ISN
    --                                                                 AND GRDI.GRDI_OBJECT_GROUP_ISN = GRPHR.GRPHR_GROUP_ISN
    --                                                                 AND GRDI.GRDI_DELETED = 0
WHERE F.FLUP_SCHEDULED_DATE + TO_DATE ('02/01/0001', 'DD/MM/YYYY') BETWEEN to_date('27/04/2018','DD/MM/YYYY') AND to_date('28/04/2018','DD/MM/YYYY')
AND F.FLUP_FLIGHT_NO_LVG = 'UA'
AND F.FLUP_FLIGHT_NO = '855'


/// guias consolidadas que se mostraran al desplegar el vuelo
SELECT DISTINCT 
F.FLUP_FLIGHT_NO_LVG, 
F.FLUP_FLIGHT_NO NU_VUEL,
LPAD ( LPAD (LABS_MAWB_PREFIX, 4, 0) || '' || LPAD (LABS_MAWB_SERIAL_NO, 8, 0), 12,0) AS Guia,
F.FLUP_SCHEDULED_DATE,
F.FLUP_INT_NUMBER AS MANIFEST_NUMBER,
TO_CHAR ( F.FLUP_SCHEDULED_DATE + TO_DATE ('02/01/0001', 'DD/MM/YYYY'), 'DD/MM/YYYY') AS FE_VUEL,
--SUM (GRDI.GRDI_DELIVERY_PIECES) OVER ( PARTITION BY F.FLUP_INT_NUMBER,PALO.PALO_ULD_ISN,LABS.LABS_MAWB_SERIAL_NO,HAWB.HAWB_HOUSE_NUMBER) AS NROBULTOS,
--SUM (GRDI.GRDI_DELIVERY_WEIGHT) OVER ( PARTITION BY F.FLUP_INT_NUMBER,PALO.PALO_ULD_ISN,LABS.LABS_MAWB_SERIAL_NO,HAWB.HAWB_HOUSE_NUMBER) AS NROKILOS,
'LIM' AS CO_PUER_ORIG,
F.FLUP_AIRPORT_CODE_1 AS CO_PUER_DEST

FROM LIM_W1_HL.LABS@TLMHERMES LABS
    INNER JOIN LIM_W1_HL.GRPHR_GROUP_HOUSE_RELATION@TLMHERMES GRPHR ON  LABS.LABS_IDENT_NO = GRPHR.GRPHR_AWB_IDENT AND LABS.LABS_RECORD_TYPE = 'MASTER'
    INNER JOIN LIM_W1_HL.HAWL_HOUSE_WAYBILL_LOADED@TLMHERMES HAWB_LOAD ON HAWB_LOAD.HAWL_HOUSE_ISN = GRPHR.GRPHR_HOUSE_ISN
    INNER JOIN LIM_W1_HL.HAWB_HOUSE_WAYBILL_DETAILS@TLMHERMES HAWB ON  HAWB.HAWB_HOUSE_ISN = HAWB_LOAD.HAWL_HOUSE_ISN
    INNER JOIN LIM_W1_HL.BOOK_BOOKINGS@TLMHERMES BOOK  ON            LABS.LABS_IDENT_NO = BOOK.BOOK_LABS_IDENT  -- AND BOOK_DELETED=0 /*SE AGREG0*/
    INNER JOIN LIM_W1_HL.FLUP@TLMHERMES F ON
                                                                    F.FLUP_FLIGHT_NO_LVG = BOOK.BOOK_FLIGHT_AIRLINE
                                                                    AND F.FLUP_FLIGHT_NO = BOOK.BOOK_FLIGHT_NUMBER
                                                                    AND F.FLUP_INT_NUMBER = BOOK.BOOK_FLIGHT_ISN 
    INNER JOIN LIM_W1_HL.PALO@TLMHERMES PALO   ON PALO.PALO_ULD_ISN = HAWB_LOAD.HAWL_ULD_ISN                                  
    --INNER JOIN LIM_W1_HL.CONT@TLMHERMES CONT   ON PALO.PALO_ULD_ISN = CONT.CONT_ULD_ISN AND CONT.CONT_COMPLETE_CALCULATED_ULD = 1
    --                                                                                      AND cont.CONT_FLIGHT_NO_ = F.FLUP_FLIGHT_NO
    --                                                                                      AND cont.CONT_DATE = F.FLUP_SCHEDULED_DATE
    --                                                                                      AND cont.CONT_ULD_ISN = PALO.PALO_ULD_ISN 
    --INNER JOIN LIM_W1_HL.GRDI_GROUP_DELIVERY_INFO@TLMHERMES GRDI ON  GRDI.GRDI_OBJECT_ISN = LABS.LABS_IDENT_NO
    --                                                                 AND GRDI.GRDI_ULD_ISN = HAWB_LOAD.HAWL_ULD_ISN
    --                                                                 AND GRDI.GRDI_OBJECT_GROUP_ISN = GRPHR.GRPHR_GROUP_ISN
    --                                                                 AND GRDI.GRDI_DELETED = 0
WHERE F.FLUP_SCHEDULED_DATE + TO_DATE ('02/01/0001', 'DD/MM/YYYY') BETWEEN to_date('27/04/2018','DD/MM/YYYY') AND to_date('28/04/2018','DD/MM/YYYY')
AND F.FLUP_FLIGHT_NO_LVG = 'UA'
AND F.FLUP_FLIGHT_NO = '855'

/// en esta tabla ver si ya se transmitio cada guia hija
select * from tlmexpo.TDMANI_ENVI